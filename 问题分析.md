# 横线格式丢失问题分析

## 问题描述

在文档格式转换过程中，复制MD文档格式粘贴到编辑区域正常，但HTML转DOCX时丢失了横线等DOCX原本支持的结构。问题可能出现在：
1. DOCX转HTML处理过程
2. HTML转DOCX处理过程  
3. 复制粘贴处理逻辑
4. 文件读取/保存逻辑

## 工作流程分析

### 1. 文件读取流程 (DOCX → HTML)
**位置**: `electron/docx.js` - `readDocxAsHtml()` 方法

**处理步骤**:
1. 使用mammoth库读取DOCX文件: `mammoth.convertToHtml({ path: filePath }, options)`
2. mammoth配置选项(`options.styleMap`)中只定义了基础样式映射：
   ```javascript
   styleMap: [
     "p[style-name='Heading 1'] => h1:fresh",
     "p[style-name='Heading 2'] => h2:fresh", 
     "p[style-name='Heading 3'] => h3:fresh",
     "b => strong",
     "i => em",
     "p:unordered-list(1) => ul > li:fresh",
     "p:ordered-list(1) => ol > li:fresh"
   ]
   ```
3. **关键问题**: 缺少横线的映射规则，mammoth库无法识别并转换DOCX中的分隔线
4. 调用`postProcessHtml()`进行后处理，但该函数只是简单包装`<div class="content-theme">`

**问题根因**: mammoth的styleMap配置中**没有包含横线/分隔线的映射规则**，导致DOCX中的分隔线在转换为HTML时丢失。

### 2. 编辑器显示和复制粘贴 
**位置**: `src/writing/components/DocxEditor.tsx`

**处理步骤**:
1. 编辑器使用`contentEditable`进行富文本编辑
2. 粘贴事件处理(`handlePaste`)：
   ```javascript
   const handlePaste = useCallback((e: React.ClipboardEvent) => {
     // 允许正常的粘贴行为，包括富文本
     // 不做特殊处理
   }, [])
   ```
3. 内容变化通过`handleInput`捕获并传递HTML内容

**分析**: 复制粘贴环节**没有问题**，MD格式的横线(`---`)可以正常粘贴并在编辑器中显示（CSS支持hr样式）。

### 3. 文件保存流程 (HTML → DOCX)
**位置**: `electron/docx.js` - `saveHtmlAsDocx()` 方法

**处理步骤**:
1. 调用`sanitizeHtmlForDocx()`清理HTML：
   ```javascript
   sanitizeHtmlForDocx(html) {
     return html.replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
   }
   ```
2. 构建完整HTML文档结构
3. 使用HTMLtoDOCX库转换: `HTMLtoDOCX(fullHtml, null, options)`

**问题分析**: 
- `sanitizeHtmlForDocx()`只移除style标签，不会影响hr元素
- **关键问题**: HTMLtoDOCX库可能不支持或不正确处理`<hr>`元素转换为DOCX格式的分隔线

### 4. 样式支持情况
**位置**: `src/styles/content-theme.css`

CSS中定义了hr样式：
```css
.content-theme hr { 
  border: 0; 
  border-top: 1px solid #d1d5db; 
  margin: 1rem 0; 
}
```

**分析**: 界面显示层面**支持横线显示**，问题不在前端渲染。

## 问题根因总结

横线格式丢失的主要原因有两个：

### 主要问题1: DOCX→HTML转换中丢失横线
**位置**: `electron/docx.js` 第25-44行
**原因**: mammoth库的styleMap配置缺少分隔线映射规则
**影响**: 原DOCX文件中的分隔线无法转换为HTML的`<hr>`元素

### 主要问题2: HTML→DOCX转换中丢失横线  
**位置**: `electron/docx.js` 第93-125行
**原因**: HTMLtoDOCX库可能不支持`<hr>`元素转换为DOCX分隔线
**影响**: 即使HTML中有`<hr>`元素，保存时也无法正确转换为DOCX分隔线

## 影响的工作流程

1. **原有DOCX文件读取**: 分隔线丢失 ❌
2. **MD格式复制粘贴**: 可正常显示，但保存时丢失 ⚠️  
3. **HTML内容保存**: 横线无法保存到DOCX ❌
4. **文件内容提取**: 横线信息丢失 ❌

## 技术细节补充

### mammoth库关于分隔线的处理
mammoth库文档表明，DOCX中的分隔线通常以以下方式存在：
- 使用边框样式的段落 (`p` 元素带有下边框)
- 专门的分隔线元素
- 特殊样式的段落

当前配置中缺少这些映射，例如：
```javascript
// 可能需要添加的映射规则
"p[style-name='Horizontal Line'] => hr",
"p[border-bottom] => hr", 
// 或其他DOCX分隔线的特征匹配
```

### HTMLtoDOCX库的限制
HTMLtoDOCX库主要专注于：
- 基础HTML标签 (p, h1-h6, ul, ol, li, strong, em)
- 表格 (table, tr, td, th)
- 可能**不完整支持**`<hr>`标签转换

这解释了为什么HTML中的hr元素无法正确转换为DOCX分隔线。

### 文件内容提取的影响链条
```
DOCX文件 → mammoth转换(丢失hr) → HTML显示 → extractTextFromHTML → 纯文本(丢失分隔线信息)
```

在AI上下文提取中(`src/writing/utils/fileContentReader.ts` 第11-46行)，`extractTextFromHTML`函数会将HTML转换为纯文本，分隔线信息进一步丢失。

## 解决方向

### 1. 扩展mammoth配置 (推荐)
**位置**: `electron/docx.js` 第27-40行
**方案**: 研究并添加DOCX分隔线到hr的映射规则

### 2. 增强postProcessHtml函数  
**位置**: `electron/docx.js` 第70-73行  
**方案**: 识别可能的分隔线模式并转换为`<hr>`元素

### 3. 验证HTMLtoDOCX支持或寻找替代
**位置**: `electron/docx.js` 第112行
**方案**: 
- 测试当前库对hr的支持程度
- 评估docx库、officegen等其他转换库
- 考虑预处理将hr转换为HTMLtoDOCX支持的格式

### 4. 自定义分隔线处理逻辑
**方案**: 在保存前将`<hr>`转换为HTMLtoDOCX能理解的格式，如带边框的空段落
