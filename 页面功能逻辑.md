# AI写作助手 - 功能逻辑文档

## 🎯 项目概述

**AI写作助手**是一个基于Electron的桌面应用，集成了文档编辑和AI对话功能。主要用于辅助用户进行小说写作，提供智能的AI助手来支持创作过程。

### 技术栈
- **前端框架**: React 19 + TypeScript + Vite
- **桌面框架**: Electron 37
- **UI组件库**: TailwindCSS 4.0 + React Resizable Panels  
- **文档处理**: mammoth (DOCX读取) + html-to-docx (DOCX保存)
- **Markdown渲染**: react-markdown + react-syntax-highlighter
- **AI服务**: DeepSeek API (支持v3和r1两种模式)

---

## 🏗️ 整体架构

### 应用结构
```
AI写作助手
├── 左侧：文件管理面板 (20%)
│   ├── 工作目录选择
│   ├── 文件树浏览
│   ├── 文件批量选择
│   └── 右键菜单操作
├── 中间：DOCX编辑器 (50%)
│   ├── 富文本编辑器
│   ├── 实时字数统计
│   ├── 文档保存/加载
│   └── 格式转换处理
└── 右侧：AI助手面板 (30%)
    ├── 对话历史管理
    ├── 实时聊天界面
    ├── AI配置设置
    └── 上下文文件注入
```

### 模块划分
- **主应用入口** (`App.tsx`): 简洁的应用根组件，直接渲染WritingPage
- **写作页面** (`writing/`): 核心的工作界面，整合所有功能模块
- **AI聊天** (`chat/`): 完整的AI对话系统，支持分支对话和历史管理
- **数据存储** (`storage/`): 统一的本地数据存储管理
- **文件系统** (`electron/`): Electron主进程，处理文件操作和系统交互

---

## 📱 核心功能模块

### 1. 文件管理系统 (`writing/components/FileTreePanel`)

#### 功能特性
- **工作目录管理**: 用户选择项目根目录，应用自动扫描目录结构
- **文件树展示**: 递归显示文件夹和文件，支持展开/收起
- **多文件选择**: 支持批量选择文件作为AI对话的上下文
- **文件操作**: 右键菜单支持新建、删除、重命名、复制等操作
- **内联编辑**: 双击文件名可直接重命名

#### 技术实现
- **文件树构建**: Electron主进程递归扫描目录，构建树状结构
- **状态管理**: 使用`useFileTree` hook管理文件树状态和操作
- **上下文菜单**: 通过IPC通信调用原生右键菜单
- **文件监听**: 监听文件系统变化，自动更新文件树

#### 支持格式
- **文档**: .docx, .doc, .txt, .md
- **图片**: .png, .jpg, .jpeg, .gif, .bmp, .webp, .svg
- **其他**: 基于文件扩展名自动检测处理方式

### 2. DOCX文档编辑器 (`writing/components/DocxEditor`)

#### 核心功能
- **富文本编辑**: 基于`contentEditable`的所见即所得编辑器
- **格式支持**: 完整保持DOCX的格式信息(粗体、斜体、下划线、标题、列表等)
- **实时预览**: 编辑过程中实时渲染文档格式
- **字数统计**: 实时计算字符数、单词数等统计信息
- **自动保存**: 支持Ctrl+S快捷键保存，未保存状态提示

#### 文档处理流程
1. **读取**: 使用mammoth库将DOCX转换为HTML
2. **编辑**: 用户在HTML编辑器中修改内容
3. **保存**: 将HTML内容转换回DOCX格式存储

#### 格式保持机制
- **样式映射**: 通过mammoth的styleMap配置保持Word原有格式
- **HTML后处理**: 自动识别段落中的列表标记，转换为HTML列表
- **CSS注入**: 动态添加样式确保预览效果与最终文档一致

### 3. AI对话系统 (`chat/`)

#### 架构设计
采用**分层架构**，将对话逻辑拆分为多个独立的管理器：

##### 3.1 对话管理器 (`conversation-manager.ts`)
- **状态管理**: 统一管理对话树、输入状态、加载状态
- **消息处理**: 处理用户发送消息和AI回复生成
- **流式响应**: 支持AI回复的实时流式显示
- **中断控制**: 支持中断正在生成的AI回复

##### 3.2 分支管理器 (`branch-manager.ts`)
- **分支导航**: 支持在对话的不同分支之间切换
- **路径管理**: 维护当前激活的对话路径
- **分支指示**: 显示当前分支位置和可用的导航选项

##### 3.3 对话历史管理 (`conversation-history.ts`)
- **会话管理**: 创建、保存、加载多个独立的对话会话
- **持久化**: 对话数据自动保存到localStorage
- **会话切换**: 支持在不同历史对话间快速切换

##### 3.4 树形数据结构 (`tree-utils.ts`)
- **消息树**: 将扁平的消息列表构建为树形结构
- **路径追踪**: 维护从根节点到当前节点的完整路径
- **历史重建**: 根据选定路径重建完整的对话历史

#### 对话功能特性

##### AI模式切换
- **DeepSeek-V3模式**: 标准聊天模式，支持temperature参数调节创造性
- **DeepSeek-R1模式**: 推理模式，显示AI的思考过程，适合复杂问题

##### 上下文注入
- **文件内容注入**: 将选中文件的内容作为对话上下文
- **智能处理**: 自动提取文档纯文本，图片转base64格式
- **内容缓存**: 避免重复读取，提升响应速度

##### 消息操作
- **消息重新生成**: 对AI回复不满意时可重新生成
- **用户消息编辑**: 可修改已发送的用户消息并重新获得回复
- **分支对话**: 支持从任意消息点开始新的对话分支

### 4. 数据存储系统 (`storage/`)

#### 存储策略
采用**localStorage**作为主要存储方案，提供统一的数据管理接口：

##### 存储内容
- **AI配置**: API密钥、模型参数、系统提示词等
- **对话历史**: 完整的对话树结构和元数据
- **应用设置**: 界面布局、用户偏好等

##### 数据管理
- **版本控制**: 检查存储数据的完整性，自动迁移升级
- **错误处理**: 存储失败时的降级处理和错误提示
- **缓存优化**: 内存缓存热点数据，减少读写开销

---

## 🔄 数据流与状态管理

### 应用级状态流
```
用户操作
    ↓
WritingPage (状态协调)
    ↓
┌─────────────┬─────────────┬─────────────┐
│ 文件管理     │ 文档编辑     │ AI对话      │
│ FileTree    │ DocxEditor  │ ChatPanel   │
└─────────────┴─────────────┴─────────────┘
    ↓
Storage (数据持久化)
```

### 文件操作数据流
1. **文件选择**: 用户在FileTree中选择文件
2. **内容读取**: 通过Electron IPC读取文件内容
3. **格式转换**: DOCX→HTML或直接文本读取
4. **编辑器加载**: DocxEditor显示可编辑的内容
5. **实时更新**: 用户编辑时实时更新状态
6. **保存处理**: HTML→DOCX转换后写入磁盘

### AI对话数据流
1. **消息发送**: 用户输入消息
2. **上下文构建**: 
   - 获取对话历史
   - 注入选中文件内容
   - 应用系统提示词
3. **API调用**: 发送到DeepSeek API
4. **流式响应**: 实时显示AI回复过程
5. **数据存储**: 完整对话保存到localStorage
6. **界面更新**: 更新消息列表和状态指示

---

## ⚙️ Electron集成

### 主进程功能 (`electron/main.js`)
- **窗口管理**: 创建主窗口，处理窗口生命周期
- **文件系统API**: 提供完整的文件操作接口
- **DOCX处理**: 集成mammoth和html-to-docx进行格式转换
- **右键菜单**: 原生系统右键菜单集成
- **安全策略**: 禁用node集成，启用上下文隔离

### 预加载脚本 (`electron/preload.js`)
提供安全的IPC通信接口，包括：
- 文件操作API（读取、写入、删除等）
- 目录管理API（创建、删除、重命名等）
- DOCX处理API（HTML转换、格式保持）
- 图片处理API（base64转换、元数据读取）

### 进程间通信 (IPC)
- **异步调用**: 使用`ipcMain.handle`和`ipcRenderer.invoke`
- **错误处理**: 完整的异常传递和错误提示
- **类型安全**: TypeScript类型定义确保接口一致性

---

